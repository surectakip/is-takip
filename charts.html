<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>İş Grafik Analizleri</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; background: #f4f4f4; }
    h2 { text-align: center; color: #222; }
    .chart-container { max-width: 900px; margin: 2rem auto; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    iframe { width: 100%; border: none; }
  </style>
</head>
<body>
  <h2>İş Grafik Analizleri</h2>
  <div id="chart1" class="chart-container"></div>
  <div id="chart2" class="chart-container"></div>
  <div id="chart3" class="chart-container"></div>
  <div id="chart4" class="chart-container"></div>

  <script>
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(fetchAndDraw);

    async function fetchAndDraw() {
      const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3FYXQ_1zylldMKZ73oBRLvbE0QgfOfdZoR6ZP6Pay-D_YH2uuiptRt5XsJIQekxOkbwRplBBGNT4u/pub?output=csv";
      const res = await fetch(url);
      const text = await res.text();
      const rows = text.trim().split('\n').map(r => r.split(','));
      const headers = rows.shift();

      // Kolon indeksleri
      const sorumluIdx = headers.indexOf("Sorumlu");
      const durumIdx = headers.indexOf("Durum");
      const oncelikIdx = headers.indexOf("\u00d6ncelik");
      const baslangicIdx = headers.indexOf("Başlangıç Tarihi");
      const bitisIdx = headers.indexOf("Bitiş Tarihi");

      const data = rows.map(r => ({
        sorumlu: r[sorumluIdx],
        durum: r[durumIdx],
        oncelik: r[oncelikIdx],
        sure: daysBetween(r[baslangicIdx], r[bitisIdx])
      }));

      drawSorumluChart(data);
      drawDurumChart(data);
      drawOncelikChart(data);
      drawSureChart(data);
    }

    function daysBetween(start, end) {
      try {
        const s = new Date(start);
        const e = new Date(end);
        return (e - s) / (1000 * 60 * 60 * 24);
      } catch { return 0; }
    }

    function drawSorumluChart(data) {
      const counts = {};
      data.forEach(d => { counts[d.sorumlu] = (counts[d.sorumlu] || 0) + 1; });
      const chartData = [['Sorumlu', 'İş Sayısı']].concat(
        Object.entries(counts)
      );
      const dt = google.visualization.arrayToDataTable(chartData);
      const chart = new google.visualization.ColumnChart(document.getElementById('chart1'));
      chart.draw(dt, {title: 'Sorumluya Göre İş Dağılımı'});
    }

    function drawDurumChart(data) {
      const counts = {};
      data.forEach(d => { counts[d.durum] = (counts[d.durum] || 0) + 1; });
      const chartData = [['Durum', 'Adet']].concat(
        Object.entries(counts)
      );
      const dt = google.visualization.arrayToDataTable(chartData);
      const chart = new google.visualization.PieChart(document.getElementById('chart2'));
      chart.draw(dt, {title: 'Duruma Göre İş Dağılımı'});
    }

    function drawOncelikChart(data) {
      const counts = {};
      data.forEach(d => { counts[d.oncelik] = (counts[d.oncelik] || 0) + 1; });
      const chartData = [['Öncelik', 'Adet']].concat(
        Object.entries(counts)
      );
      const dt = google.visualization.arrayToDataTable(chartData);
      const chart = new google.visualization.ColumnChart(document.getElementById('chart3'));
      chart.draw(dt, {title: 'Öncelik Durumuna Göre İşler'});
    }

    function drawSureChart(data) {
      const chartData = [['Sorumlu', 'Süre (gün)']].concat(
        data.map(d => [d.sorumlu + ' (' + d.durum + ')', d.sure])
      );
      const dt = google.visualization.arrayToDataTable(chartData);
      const chart = new google.visualization.BarChart(document.getElementById('chart4'));
      chart.draw(dt, {title: 'İş Süreleri Karşılaştırması'});
    }
  </script>
</body>
</html>
