
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>İş Takip Sistemi</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; background: #f9f9f9; margin: 20px; }
    button { margin: 5px; padding: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>İş Takip Sistemi</h1>
  <nav>
    <button onclick="showTab('ana')">📋 Ana Tablo</button>
    <button onclick="showTab('gecikmis')">⏱ Gecikmiş İşler</button>
    <button onclick="showTab('analiz')">📊 Analiz</button>
    <button onclick="showTab('form')">📝 Veri Girişi</button>
    <button onclick="loadData()">🔄 Yenile</button>
  </nav>

  <section id="ana"><h3>Ana Tablo</h3><table id="mainTable"></table></section>
  <section id="gecikmis" class="hidden"><h3>Süresi Geçmiş İşler</h3><table id="lateTable"></table></section>
  <section id="analiz" class="hidden">
    <h3>Analiz</h3>
    <canvas id="chartDurum"></canvas><br />
    <canvas id="chartSorumlu"></canvas>
  </section>
  <section id="form" class="hidden">
    <h3>Veri Girişi</h3>
    <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSeO5gyy2PE4zRvj_OUhTE00M63M_xezHDMtjsdU4FcOWqc9lw/viewform?embedded=true" width="640" height="2000" frameborder="0">Yükleniyor…</iframe>
  </section>

<script>
  const sheetId = "1lhW-0Gn38DH-GYPOHZkvZvfL8hsaNYj6vyA_Rnli7EU";
  const sheetName = "Form Yanıtları 1";
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}`;

  function showTab(id) {
    document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
  }

  function loadData() {
    fetch(url)
      .then(res => res.text())
      .then(text => {
        const data = JSON.parse(text.substr(47).slice(0, -2));
        const rows = data.table.rows.map(r => r.c.map(c => c?.v || ""));
        drawTable("mainTable", data.table.cols.map(c => c.label), rows);
        drawLateTable(rows);
        drawCharts(rows);
      });
  }

  function drawTable(tableId, headers, rows) {
    const table = document.getElementById(tableId);
    let html = "<thead><tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr></thead><tbody>";
    rows.forEach(r => {
      html += "<tr>" + r.map(d => `<td>${d}</td>`).join("") + "</tr>";
    });
    html += "</tbody>";
    table.innerHTML = html;
  }

  function drawLateTable(rows) {
    const lateRows = rows.filter(r => {
      const tarih = new Date(r[5]);
      const bugun = new Date();
      return r[6] !== "Tamamlandı" && tarih < bugun;
    });
    drawTable("lateTable", ["Zaman", "İş Başlığı", "İş Tanımı", "Sorumlu", "Başlangıç", "Bitiş", "Durum", "Öncelik", "Not", "Hatırlatma"], lateRows);
  }

  function drawCharts(rows) {
    const durumlar = {};
    const sorumlu = {};

    rows.forEach(r => {
      const d = r[6]; const s = r[3];
      durumlar[d] = (durumlar[d] || 0) + 1;
      sorumlu[s] = (sorumlu[s] || 0) + 1;
    });

    new Chart(document.getElementById("chartDurum"), {
      type: "pie",
      data: {
        labels: Object.keys(durumlar),
        datasets: [{ data: Object.values(durumlar) }]
      }
    });

    new Chart(document.getElementById("chartSorumlu"), {
      type: "bar",
      data: {
        labels: Object.keys(sorumlu),
        datasets: [{ label: "Sorumluya Göre İş Sayısı", data: Object.values(sorumlu) }]
      }
    });
  }

  loadData();
</script>
</body>
</html>
