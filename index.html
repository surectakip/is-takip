<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>İş ve Süreç Takip Sistemi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; }
    header { background-color: #0d6efd; color: white; padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; }
    nav { margin-top: 1rem; text-align: center; }
    .nav-link { display: inline-block; margin: 0 5px; font-weight: bold; }
    .nav-link.active { background-color: #198754 !important; color: white !important; }
    .tab-content { margin-top: 1.5rem; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    .reminder-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: flex; align-items: center;
      justify-content: center; z-index: 9999;
    }
    .reminder-box {
      background: white; padding: 2rem; border-radius: 10px;
      max-width: 400px; box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    canvas { max-width: 400px; margin: 1rem auto; display: block; }
  </style>
</head>
<body>
  <header>📋 İş ve Süreç Takip Sistemi</header>
  <nav class="nav nav-tabs justify-content-center">
    <a class="nav-link active" href="#tablo" onclick="showTab('tablo')">🏠 Ana Sayfa</a>
    <a class="nav-link" href="#form" onclick="showTab('form')">📝 Veri Girişi</a>
    <a class="nav-link" href="#grafik" onclick="showTab('grafik')">📊 Sorumlu Özeti</a>
  </nav>

  <main class="container">
    <div class="tab-content">
      <section id="tablo" class="tab-pane active">
        <h4 class="mt-4">🔍 Kayıtlar</h4>
        <div class="row mb-3">
          <div class="col-md-3"><input type="text" class="form-control" id="titleFilter" placeholder="İş Başlığı"></div>
          <div class="col-md-3"><input type="text" class="form-control" id="responsibleFilter" placeholder="Sorumlu"></div>
          <div class="col-md-3">
            <select class="form-select" id="statusFilter">
              <option value="">Tümü</option>
              <option value="Devam Ediyor">Devam Ediyor</option>
              <option value="Tamamlandı">Tamamlandı</option>
              <option value="Bekliyor">Bekliyor</option>
            </select>
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary me-2" onclick="applyFilters()">Filtrele</button>
            <button class="btn btn-secondary" onclick="clearFilters()">Temizle</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th>İş Başlığı</th>
                <th>İş Tanımı</th>
                <th>Sorumlu</th>
                <th>Başlangıç</th>
                <th>Bitiş</th>
                <th>Durum</th>
                <th>Öncelik</th>
                <th>Not</th>
              </tr>
            </thead>
            <tbody id="dataTable"></tbody>
          </table>
        </div>
      </section>

      <section id="form" class="tab-pane">
        <h4 class="mt-4">📝 Yeni Kayıt Ekle</h4>
        <p><a href="https://forms.gle/euosi3bVqsMn5zBp9" target="_blank">➡ Google Formu Buradan Aç</a></p>
        <p>Form yeni sekmede açılacaktır. Veriler tabloya otomatik yansıyacaktır.</p>
      </section>

      <section id="grafik" class="tab-pane">
        <h4 class="mt-4">📊 Grafiksel Analizler</h4>
        <canvas id="durumChart"></canvas>
        <canvas id="oncelikChart"></canvas>
        <canvas id="ayChart"></canvas>
        <div id="summaryList" class="mt-4"></div>
      </section>
    </div>
  </main>

  <div id="reminderModal" class="reminder-modal" style="display:none">
    <div class="reminder-box">
      <h5>Hatırlatmalar</h5>
      <ul id="reminderList"></ul>
      <button class="btn btn-sm btn-danger mt-3" onclick="document.getElementById('reminderModal').style.display='none'">Kapat</button>
    </div>
  </div>

  <script>
    function showTab(tabId) {
      document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
      document.querySelector(`[href='#${tabId}']`).classList.add('active');
    }

    function formatDate(input) {
      const date = new Date(input);
      if (isNaN(date)) return "";
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    async function fetchData() {
      const res = await fetch("https://docs.google.com/spreadsheets/d/1Ppo2L8kO8fgOmFrY956MdGOVjyfOBDnbcvOx2KmR0fY/gviz/tq?tqx=out:json");
      const text = await res.text();
      const json = JSON.parse(text.substring(47).slice(0, -2));
      const data = json.table.rows.map(row => row.c.map(cell => cell?.v || ""));
      globalThis.globalData = data;
      renderTable(data);
      renderCharts(data);
      renderSummary(data);
      checkReminders(data);
    }

    function renderTable(data) {
      const table = document.getElementById("dataTable");
      table.innerHTML = "";
      data.forEach(row => {
        const [ , title, desc, responsible, start, end, status, priority, note ] = row;
        table.innerHTML += `<tr>
          <td>${title}</td>
          <td>${desc}</td>
          <td>${responsible}</td>
          <td>${formatDate(start)}</td>
          <td>${formatDate(end)}</td>
          <td>${status}</td>
          <td>${priority}</td>
          <td>${note}</td>
        </tr>`;
      });
    }

    function applyFilters() {
      const title = document.getElementById("titleFilter").value.toLowerCase();
      const responsible = document.getElementById("responsibleFilter").value.toLowerCase();
      const status = document.getElementById("statusFilter").value;
      const filtered = globalData.filter(row => {
        return (!title || row[1]?.toLowerCase().includes(title)) &&
               (!responsible || row[3]?.toLowerCase().includes(responsible)) &&
               (!status || row[6] === status);
      });
      renderTable(filtered);
    }

    function clearFilters() {
      document.getElementById("titleFilter").value = "";
      document.getElementById("responsibleFilter").value = "";
      document.getElementById("statusFilter").value = "";
      renderTable(globalData);
    }

    function checkReminders(data) {
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const reminders = [];
      data.forEach(row => {
        const [ , title, , , startRaw, endRaw, , , , reminderDays ] = row;
        const start = new Date(startRaw);
        const end = new Date(endRaw);
        if (!isNaN(start) && reminderDays) {
          const reminderDate = new Date(start);
          reminderDate.setDate(reminderDate.getDate() + parseInt(reminderDays));
          reminderDate.setHours(0,0,0,0);
          if (reminderDate.getTime() === today.getTime()) {
            reminders.push(`🔔 ${title} - Hatırlatma günü geldi.`);
          }
        }
        if (!isNaN(end)) {
          end.setHours(0,0,0,0);
          if (end.getTime() === today.getTime()) {
            reminders.push(`⏰ ${title} - Bitiş süresi bugün doluyor.`);
          }
        }
      });
      if (reminders.length > 0) {
        const list = document.getElementById("reminderList");
        list.innerHTML = reminders.map(item => `<li>${item}</li>`).join("");
        document.getElementById("reminderModal").style.display = "flex";
      }
    }

    function renderCharts(data) {
      const statusCounts = {}, priorityCounts = {}, monthCounts = {};
      data.forEach(row => {
        const status = row[6];
        const priority = row[7];
        const date = new Date(row[4]);
        const month = isNaN(date) ? "Bilinmeyen" : date.toLocaleString('tr-TR', { month: 'long' });
        statusCounts[status] = (statusCounts[status] || 0) + 1;
        priorityCounts[priority] = (priorityCounts[priority] || 0) + 1;
        monthCounts[month] = (monthCounts[month] || 0) + 1;
      });
      new Chart(document.getElementById("durumChart"), {
        type: 'pie',
        data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts) }] }
      });
      new Chart(document.getElementById("oncelikChart"), {
        type: 'bar',
        data: { labels: Object.keys(priorityCounts), datasets: [{ data: Object.values(priorityCounts) }] }
      });
      new Chart(document.getElementById("ayChart"), {
        type: 'line',
        data: { labels: Object.keys(monthCounts), datasets: [{ data: Object.values(monthCounts) }] }
      });
    }

    function renderSummary(data) {
      const summary = {};
      data.forEach(row => {
        const responsible = row[3];
        const status = row[6];
        if (!summary[responsible]) summary[responsible] = { toplam: 0, tamamlandı: 0, bekliyor: 0 };
        summary[responsible].toplam++;
        if (status.toLowerCase() === "tamamlandı") summary[responsible].tamamlandı++;
        else summary[responsible].bekliyor++;
      });
      let html = `<h5 class="mt-4">Sorumlu Özeti</h5><table class="table table-bordered"><thead><tr><th>Sorumlu</th><th>Toplam</th><th>Tamamlandı</th><th>Bekliyor</th></tr></thead><tbody>`;
      for (const [key, val] of Object.entries(summary)) {
        html += `<tr><td>${key}</td><td>${val.toplam}</td><td>${val.tamamlandı}</td><td>${val.bekliyor}</td></tr>`;
      }
      html += `</tbody></table>`;
      document.getElementById("summaryList").innerHTML = html;
    }

    fetchData();
  </script>
</body>
</html>
