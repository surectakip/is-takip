<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Ä°ÅŸ SÃ¼reÃ§ Takip & DÃ¼zenleme</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:1rem; }
    table { width:100%; border-collapse: collapse; margin-bottom:1rem; }
    th, td { padding:.5rem; border:1px solid #ddd; text-align:left; }
    th { background:#f0f0f0; }
    button { padding:.25rem .5rem; margin:0 .25rem; }
    select { margin-right:.5rem; }
  </style>
</head>
<body>

  <h1>CanlÄ± Tablo & DÃ¼zenleme</h1>
  <button onclick="loadAndRender()">Yenile ðŸ”„</button>
  <table id="dataTable">
    <thead>
      <tr>
        <th>Sil</th>
        <th>ID</th><th>BaÅŸlÄ±k</th><th>TanÄ±m</th><th>Sorumlu</th>
        <th>BaÅŸlangÄ±Ã§</th><th>BitiÅŸ</th><th>Durum</th>
        <th>GÃ¼ncelle</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const sheetID = '1lhW-0Gn38DH-GYPOHZkvZvfL8hsaNYj6vyA_Rnli7EU';
    const sheetName = 'Form YanÄ±tlarÄ± 1';
    const query = encodeURIComponent('SELECT A,B,C,D,E,F,G,H');
    const JSON_URL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${query}`;
    const API_URL  = 'https://script.google.com/macros/s/AKfycbwa4CTOR7vmkySj5LNPwqOZHE61k1eXN6eEIvIoGDKsVzR57-WSWtAqgLlmFmDGBjXr/exec';

    async function loadAndRender() {
      const res = await fetch(JSON_URL);
      const txt = await res.text();
      const data = JSON.parse(txt.substr(47).slice(0,-2)).table.rows;
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';

      data.forEach((row,i) => {
        const vals = row.c.map(c=> c? c.v : '');
        // [ID, BaÅŸlÄ±k, TanÄ±m, Sorumlu, BaÅŸ, Bit, Durum, Ã–ncelik]
        const [ID, title, desc, owner, start, end, status] = vals;
        const tr = document.createElement('tr');

        // Sil butonu
        const tdDel = document.createElement('td');
        tdDel.innerHTML = `<button onclick="deleteRow(${i+2},'${ID}')">Sil</button>`;
        tr.appendChild(tdDel);

        // Veri hÃ¼creleri
        [ID, title, desc, owner, start, end, status].forEach((v,idx) => {
          const td = document.createElement('td');
          td.textContent = v;
          tr.appendChild(td);
        });

        // Durum dropdown + GÃ¼ncelle
        const tdUpd = document.createElement('td');
        tdUpd.innerHTML = `
          <select id="status-${i}">
            <option${status==='Devam'?' selected':''}>Devam</option>
            <option${status==='TamamlandÄ±'?' selected':''}>TamamlandÄ±</option>
          </select>
          <button onclick="updateStatus(${i+2}, '${ID}')">GÃ¼ncelle</button>
        `;
        tr.appendChild(tdUpd);

        tbody.appendChild(tr);
      });
    }

    // SatÄ±r numarasÄ± (sheet'teki index) ve ID ile sil
    async function deleteRow(rowNum, ID) {
      if(!confirm(ID+' silinsin mi?')) return;
      const payload = { action:'delete', row: rowNum };
      const res = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      alert(j.status==='ok' ? 'Silindi' : 'Hata: '+j.message);
      loadAndRender();
    }

    // SatÄ±r numarasÄ± ve ID ile sadece Durum hÃ¼cresini gÃ¼ncelle
    async function updateStatus(rowNum, ID) {
      const sel = document.getElementById(`status-${rowNum-2}`);
      const newStatus = sel.value;
      const payload = { action:'update', row: rowNum, col: 7, value: newStatus };
      const res = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      alert(j.status==='ok' ? 'GÃ¼ncellendi' : 'Hata: '+j.message);
      loadAndRender();
    }

    // BaÅŸlangÄ±Ã§ta tabloyu yÃ¼kle
    loadAndRender();
  </script>

</body>
</html>
