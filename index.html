<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>İş - Süreç Takip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Frappe Gantt UMD -->
  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f9; }
    header { background: #2c3e50; color: white; padding: 15px; text-align: center; }
    nav { display: flex; justify-content: center; background: #ecf0f1; padding: 10px; }
    nav button { margin: 0 5px; padding: 10px 16px; border:none; background:#3498db; color:white; border-radius:6px; cursor:pointer; }
    nav button:hover { background:#2980b9; }
    .tab { display:none; padding:20px; max-width:1200px; margin:auto; }
    .visible { display:block; }
    input, select, button { padding:8px; margin:5px 0; width:100%; box-sizing:border-box; }
    @media(min-width:600px){ input,select,button{ width:auto; display:inline-block; margin-right:10px; } }
    table { width:100%; border-collapse:collapse; background:white; margin-top:10px; }
    th, td { padding:10px; border:1px solid #ddd; text-align:left; }
    th { background:#bdc3c7; }
    canvas { width:100%; margin-top:20px; }
    #ganttTab { margin-top:20px; height:400px; }
  </style>
</head>
<body>
  <header><h1>İş - Süreç Takip Sistemi</h1></header>
  <nav>
    <button onclick="showTab('ana')">Ana Tablo</button>
    <button onclick="showTab('analiz')">Analiz</button>
    <button onclick="showTab('timeline')">Zaman Çizelgesi</button>
    <button onclick="showTab('form')">Veri Girişi</button>
    <button onclick="loadRecords()">Yenile</button>
  </nav>

  <!-- Firebase Initialization -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBLP7d6Ba6rYqb4eFzkwtQFZjRCObJ5_6g",
      authDomain: "is-takip-proje.firebaseapp.com",
      projectId: "is-takip-proje",
      storageBucket: "is-takip-proje.appspot.com",
      messagingSenderId: "1029231933695",
      appId: "1:1029231933695:web:405af52605d2a0a8cff4ca"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const collection = db.collection('isTakip');
  </script>

  <!-- Sections -->
  <section id="ana" class="tab visible">
    <h2>Ana Tablo</h2>
    <input id="filter-isAdi" placeholder="İş Adına Göre Filtrele..." />
    <input id="filter-daire" placeholder="Daireye Göre Filtrele..." />
    <button onclick="loadRecords()">Filtre Uygula</button>
    <table><thead><tr><th>İş Adı</th><th>Daire</th><th>İş Tanımı</th><th>Başlangıç</th><th>Bitiş</th></tr></thead><tbody id="records"></tbody></table>
  </section>

  <section id="analiz" class="tab">
    <h2>Analizler</h2>
    <canvas id="chart1"></canvas>
    <canvas id="chart2"></canvas>
  </section>

  <section id="timeline" class="tab">
    <h2>Zaman Çizelgesi</h2>
    <div id="ganttTab"></div>
  </section>

  <section id="form" class="tab">
    <h2>Yeni Kayıt</h2>
    <form id="add-form" onsubmit="addRecord(event)">
      <input id="f-isAdi" placeholder="İş Adı" required />
      <input id="f-daire" placeholder="Daire" required />
      <input id="f-tanim" placeholder="İş Tanımı" />
      <input type="date" id="f-baslangic" />
      <input type="date" id="f-bitis" />
      <button type="submit">Kaydet</button>
    </form>
  </section>

  <!-- Main Script -->
  <script>
    function showTab(id) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('visible'));
      document.getElementById(id).classList.add('visible');
      if (id === 'timeline') drawGantt();
    }

    let allRecords = [];

    async function loadRecords() {
      const isFilter = document.getElementById('filter-isAdi').value.toLowerCase();
      const daireFilter = document.getElementById('filter-daire').value.toLowerCase();
      const snapshot = await collection.orderBy('timestamp', 'desc').get();
      allRecords = snapshot.docs.map(doc => doc.data());
      const filtered = allRecords.filter(r =>
        (!isFilter || r.isAdi.toLowerCase().includes(isFilter)) &&
        (!daireFilter || r.daire.toLowerCase().includes(daireFilter))
      );
      renderTable(filtered);
      renderCharts(filtered);
    }

    function renderTable(arr) {
      const tbody = document.getElementById('records'); tbody.innerHTML = '';
      arr.forEach(r => {
        const tr = document.createElement('tr');
        ['isAdi','daire','isTanim','baslangic','bitis'].forEach(key => {
          const td = document.createElement('td'); td.textContent = r[key] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function renderCharts(arr) {
      const countDurum = {}, countDaire = {};
      arr.forEach(r => {
        countDurum[r.durum] = (countDurum[r.durum]||0) + 1;
        countDaire[r.daire] = (countDaire[r.daire]||0) + 1;
      });
      if (window.chart1) chart1.destroy();
      window.chart1 = new Chart(document.getElementById('chart1'), { type:'pie', data:{ labels:Object.keys(countDurum), datasets:[{ data:Object.values(countDurum) }] }});
      if (window.chart2) chart2.destroy();
      window.chart2 = new Chart(document.getElementById('chart2'), { type:'bar', data:{ labels:Object.keys(countDaire), datasets:[{ label:'Daire Bazlı', data:Object.values(countDaire) }] }});
    }

    async function addRecord(e) {
      e.preventDefault();
      const newRec = {
        isAdi: document.getElementById('f-isAdi').value,
        daire: document.getElementById('f-daire').value,
        isTanim: document.getElementById('f-tanim').value,
        baslangic: document.getElementById('f-baslangic').value,
        bitis: document.getElementById('f-bitis').value,
        durum: 'Beklemede',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      await collection.add(newRec);
      loadRecords();
      document.getElementById('add-form').reset();
    }

    function drawGantt() {
      const tasks = allRecords.map((r,i) => ({ id:'g'+i, name:r.isAdi, start:r.baslangic, end:r.bitis, progress: r.durum === 'Tamamlandı'?100:0 }));
      document.getElementById('ganttTab').innerHTML = '';
      if (!tasks.length) return document.getElementById('ganttTab').textContent = 'Gösterilecek görev yok.';
      new Gantt(document.getElementById('ganttTab'), tasks, { view_mode:'Week', date_format:'DD-MM-YYYY' });
    }

    window.addEventListener('load', () => {
      document.getElementById('add-form').addEventListener('submit', addRecord);
      loadRecords();
    });
  </script>
</body>
</html>
