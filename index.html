<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>İş ve Süreç Takip Sistemi</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Roboto', sans-serif; margin: 0; background: #f4f6f9; }
    header { background: #2c3e50; color: white; padding: 1rem; text-align: center; font-size: 1.5rem; }
    nav { background: #34495e; padding: 10px; text-align: center; }
    .tablink { margin: 0 5px; padding: 10px 20px; border: none; background: #bdc3c7; color: #2c3e50; cursor: pointer; font-weight: bold; border-radius: 5px; }
    .tablink.active { background: #1abc9c; color: white; }
    section { display: none; padding: 1rem; max-width: 1000px; margin: auto; }
    section.active { display: block; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; font-size: 14px; }
    th { background: #ecf0f1; }
    input, select, button { margin: 5px; padding: 6px 10px; font-size: 14px; }
    button { cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #ecf0f1; }
    button:hover { background: #d0d3d4; }
    h3, h2 { margin-top: 1.5rem; }
    #reminderModal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;
    }
    #reminderModal > div {
      background:white; padding:20px; border-radius:8px; width:80%; max-width:600px;
    }
  </style>
</head>
<body>
  <header>📋 İş ve Süreç Takip Sistemi</header>
  <nav>
    <button class="tablink active" onclick="switchTab('ana')">🏠 Ana Sayfa</button>
    <button class="tablink" onclick="switchTab('formekrani')">📝 Veri Girişi</button>
    <button class="tablink" onclick="switchTab('ozet')">📊 Sorumlu Özeti</button>
  </nav>

  <section id="ana" class="active">
    <h3>🔍 Kayıtlar</h3>
    <label>İş Başlığı:</label><input type="text" id="titleFilter">
    <label>Sorumlu:</label><input type="text" id="responsibleFilter">
    <label>Durum:</label>
    <select id="statusFilter">
      <option value="">Tümü</option>
      <option value="Devam Ediyor">Devam Ediyor</option>
      <option value="Tamamlandı">Tamamlandı</option>
      <option value="Bekliyor">Bekliyor</option>
    </select>
    <button onclick="applyFilters()">Filtrele</button>
    <button onclick="clearFilters()">Temizle</button>
    <table id="dataTable"></table>
  </section>

  <section id="formekrani">
    <h3>📝 Yeni Kayıt Ekle</h3>
    <p><a href="https://forms.gle/euosi3bVqsMn5zBp9" target="_blank" style="color:#2980b9; font-weight:bold;">➡ Google Formu Buradan Aç</a></p>
    <p>Form yeni sekmede açılacaktır. Veriler tabloya otomatik yansıyacaktır.</p>
  </section>

  <section id="ozet">
    <h3>📊 Sorumlu Özeti</h3>
    <div id="summaryContainer"></div>
  </section>

  <div id="reminderModal">
    <div>
      <h3>📅 Bugün Hatırlatılacak veya Süresi Dolmuş İşler</h3>
      <ul id="reminderList"></ul>
      <button onclick="document.getElementById('reminderModal').style.display='none'">Kapat</button>
    </div>
  </div>

  <script>
    const SHEET_ID = "1Ppo2L8kO8fgOmFrY956MdGOVjyfOBDnbcvOx2KmR0fY";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
    let globalData = [];

    function switchTab(tabId) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tablink').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
      if (tabId === 'ozet') renderSummary();
    }

    function formatDate(input) {
      const d = new Date(input);
      return !isNaN(d) ? d.toLocaleDateString("tr-TR") : "";
    }

    async function fetchData() {
      const res = await fetch(SHEET_URL);
      const text = await res.text();
      const json = JSON.parse(text.substring(47).slice(0, -2));
      return json.table.rows.map(row => row.c.map(cell => cell ? cell.v : ""));
    }

    function renderTable(data) {
      const table = document.getElementById("dataTable");
      table.innerHTML = `<tr><th>İş Başlığı</th><th>İş Tanımı</th><th>Sorumlu</th><th>Başlangıç</th><th>Bitiş</th><th>Durum</th><th>Öncelik</th><th>Not</th></tr>`;
      data.forEach(row => {
        const [ , title, desc, responsible, start, end, status, priority, note ] = row;
        table.innerHTML += `<tr>
          <td>${title}</td>
          <td>${desc}</td>
          <td>${responsible}</td>
          <td>${formatDate(start)}</td>
          <td>${formatDate(end)}</td>
          <td>${status}</td>
          <td>${priority}</td>
          <td>${note}</td>
        </tr>`;
      });
    }

    function applyFilters() {
      const title = document.getElementById("titleFilter").value.toLowerCase();
      const responsible = document.getElementById("responsibleFilter").value.toLowerCase();
      const status = document.getElementById("statusFilter").value;
      const filtered = globalData.filter(row => {
        return (!title || row[1]?.toLowerCase().includes(title)) &&
               (!responsible || row[3]?.toLowerCase().includes(responsible)) &&
               (!status || row[6] === status);
      });
      renderTable(filtered);
    }

    function clearFilters() {
      document.getElementById("titleFilter").value = "";
      document.getElementById("responsibleFilter").value = "";
      document.getElementById("statusFilter").value = "";
      renderTable(globalData);
    }

    function renderSummary() {
      const summary = {};
      globalData.forEach(row => {
        const responsible = row[3] || "Bilinmiyor";
        const status = row[6] || "Bekliyor";
        if (!summary[responsible]) summary[responsible] = { total: 0, Tamamlandı: 0, Bekliyor: 0 };
        summary[responsible].total++;
        summary[responsible][status]++;
      });
      let html = `<table><tr><th>Sorumlu</th><th>Toplam</th><th>Tamamlandı</th><th>Bekliyor</th></tr>`;
      for (let res in summary) {
        html += `<tr><td>${res}</td><td>${summary[res].total}</td><td>${summary[res].Tamamlandı}</td><td>${summary[res].Bekliyor}</td></tr>`;
      }
      html += `</table>`;
      document.getElementById("summaryContainer").innerHTML = html;
    }

    function checkReminders(data) {
      const today = new Date();
      today.setHours(0,0,0,0);
      const reminders = [];
      data.forEach(row => {
        const [ , title, , , startRaw, endRaw, , , , reminderDays] = row;
        const start = new Date(startRaw);
        const end = new Date(endRaw);

        if (!isNaN(start) && reminderDays) {
          const reminderDate = new Date(start);
          reminderDate.setDate(reminderDate.getDate() + parseInt(reminderDays));
          reminderDate.setHours(0,0,0,0);
          if (reminderDate.getTime() === today.getTime()) {
            reminders.push(`🔔 ${title} - Hatırlatma günü geldi.`);
          }
        }

        if (!isNaN(end)) {
          end.setHours(0,0,0,0);
          if (end.getTime() === today.getTime()) {
            reminders.push(`⏰ ${title} - Bitiş süresi bugün doluyor.`);
          }
        }
      });
      if (reminders.length > 0) {
        document.getElementById("reminderList").innerHTML = reminders.map(r => `<li>${r}</li>`).join('');
        document.getElementById("reminderModal").style.display = "flex";
      }
    }

    (async () => {
      globalData = await fetchData();
      renderTable(globalData);
      checkReminders(globalData);
    })();
  </script>
</body>
</html>
