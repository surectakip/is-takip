<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>İş ve Süreç Takip Sistemi</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f7f9fc; font-family: sans-serif; }
    header { background: #0d6efd; color: white; padding: 1rem; text-align: center; margin-bottom: 1rem; }
    nav { margin-bottom: 1rem; text-align: center; }
    nav button { margin: 0.3rem; }
    section { display: none; padding: 1rem; }
    section.active { display: block; }
    table { width: 100%; margin-top: 1rem; }
    th, td { white-space: nowrap; }
    .tamamlandi { background-color: #d4edda !important; }
    .gecikti { background-color: #f8d7da !important; }
    canvas { max-width: 600px; margin: 2rem auto; }
  </style>
</head>
<body>
  <header>
    <h1>İş ve Süreç Takip Sistemi</h1>
  </header>

  <nav>
    <button onclick="showSection('tablo')" class="btn btn-outline-primary">Ana Sayfa</button>
    <button onclick="showSection('ozet')" class="btn btn-outline-success">Sorumlu Özeti</button>
    <button onclick="showSection('grafikler')" class="btn btn-outline-warning">Grafikler</button>
    <button onclick="showSection('form')" class="btn btn-outline-info">Veri Girişi</button>
  </nav>

  <section id="tablo" class="active">
    <div class="input-group mb-3">
      <input type="text" id="filterTitle" class="form-control" placeholder="İş Başlığına göre filtrele">
      <input type="text" id="filterResponsible" class="form-control" placeholder="Sorumluya göre filtrele">
      <button class="btn btn-primary" onclick="applyFilters()">Filtrele</button>
      <button class="btn btn-secondary" onclick="clearFilters()">Temizle</button>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered table-sm">
        <thead>
          <tr>
            <th>İş Başlığı</th><th>İş Tanımı</th><th>Sorumlu</th><th>Başlangıç Tarihi</th><th>Bitiş Tarihi</th><th>Durum</th><th>Öncelik</th><th>Not</th><th>Hatırlatma</th>
          </tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>
  </section>

  <section id="ozet">
    <div id="summary"></div>
  </section>

  <section id="grafikler">
    <canvas id="chartDurum"></canvas>
    <canvas id="chartOncelik"></canvas>
    <canvas id="chartAy"></canvas>
  </section>

  <section id="form">
    <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScJcS29cdGxv4yYkGUFfDZ9prp6A7TUtlHQO9PZmlfGyaL_cw/viewform?embedded=true" width="100%" height="800" frameborder="0" marginheight="0" marginwidth="0">Yükleniyor…</iframe>
  </section>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/1Ppo2L8kO8fgOmFrY956MdGOVjyfOBDnbcvOx2KmR0fY/gviz/tq?tqx=out:json";
    let globalData = [];

    function showSection(id) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function fetchData() {
      fetch(sheetUrl)
        .then(res => res.text())
        .then(rep => JSON.parse(rep.substr(47).slice(0, -2)))
        .then(json => {
          const rows = json.table.rows.map(r => r.c.map(c => c ? c.v : ""));
          globalData = rows.map(row => ({
            title: row[1], desc: row[2], responsible: row[3],
            start: row[4], end: row[5], status: row[6],
            priority: row[7], note: row[8], reminder: row[9]
          }));
          renderTable(globalData);
          renderSummary();
          renderCharts();
        });
    }

    function renderTable(data) {
      const tbody = document.getElementById('dataBody');
      tbody.innerHTML = "";
      data.forEach(item => {
        const tr = document.createElement('tr');
        if (item.status.toLowerCase().includes('tamam')) tr.classList.add('tamamlandi');
        if (new Date(item.end) < new Date() && !item.status.toLowerCase().includes('tamam')) tr.classList.add('gecikti');
        tr.innerHTML = `<td>${item.title}</td><td>${item.desc}</td><td>${item.responsible}</td><td>${item.start}</td><td>${item.end}</td><td>${item.status}</td><td>${item.priority}</td><td>${item.note}</td><td>${item.reminder}</td>`;
        tbody.appendChild(tr);
      });
    }

    function applyFilters() {
      const title = document.getElementById("filterTitle").value.toLowerCase();
      const responsible = document.getElementById("filterResponsible").value.toLowerCase();
      const filtered = globalData.filter(d =>
        d.title.toLowerCase().includes(title) &&
        d.responsible.toLowerCase().includes(responsible)
      );
      renderTable(filtered);
    }

    function clearFilters() {
      document.getElementById("filterTitle").value = "";
      document.getElementById("filterResponsible").value = "";
      renderTable(globalData);
    }

    function renderSummary() {
      const summary = {};
      globalData.forEach(d => {
        summary[d.responsible] = (summary[d.responsible] || 0) + 1;
      });
      let html = '<ul class="list-group">';
      for (let k in summary) {
        html += `<li class="list-group-item d-flex justify-content-between align-items-center">${k}<span class="badge bg-primary rounded-pill">${summary[k]}</span></li>`;
      }
      html += '</ul>';
      document.getElementById('summary').innerHTML = html;
    }

    function renderCharts() {
      const durumCounts = {}, oncelikCounts = {}, ayCounts = {};
      globalData.forEach(d => {
        durumCounts[d.status] = (durumCounts[d.status] || 0) + 1;
        oncelikCounts[d.priority] = (oncelikCounts[d.priority] || 0) + 1;
        const ay = new Date(d.start).toLocaleString('tr-TR', { month: 'short' });
        ayCounts[ay] = (ayCounts[ay] || 0) + 1;
      });
      new Chart(document.getElementById("chartDurum"), {
        type: 'pie',
        data: { labels: Object.keys(durumCounts), datasets: [{ data: Object.values(durumCounts) }] }
      });
      new Chart(document.getElementById("chartOncelik"), {
        type: 'bar',
        data: { labels: Object.keys(oncelikCounts), datasets: [{ data: Object.values(oncelikCounts) }] }
      });
      new Chart(document.getElementById("chartAy"), {
        type: 'line',
        data: { labels: Object.keys(ayCounts), datasets: [{ data: Object.values(ayCounts), fill: false, borderColor: 'blue' }] }
      });
    }

    fetchData();
  </script>
</body>
</html>
