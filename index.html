<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>İş Takip Sistemi</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
    header { background: #2c3e50; color: white; padding: 1rem; text-align: center; font-size: 1.5rem; }
    nav { background: #34495e; padding: 10px; text-align: center; }
    .tablink { margin: 0 5px; padding: 10px 20px; border: none; background: #bdc3c7; color: #2c3e50; cursor: pointer; font-weight: bold; border-radius: 5px; }
    .tablink.active { background: #1abc9c; color: white; }
    section { display: none; padding: 1rem; max-width: 1000px; margin: auto; }
    section.active { display: block; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; font-size: 14px; }
    th { background: #ecf0f1; }
    input, select { margin: 5px; padding: 5px; font-size: 14px; }
    iframe { width: 100%; height: 900px; border: none; }
  </style>
</head>
<body>
  <header>📋 İş ve Süreç Takip Sistemi</header>
  <nav>
    <button class="tablink active" onclick="switchTab('ana')">🏠 Ana Sayfa</button>
    <button class="tablink" onclick="switchTab('formekrani')">📝 Veri Girişi</button>
    <button class="tablink" onclick="switchTab('ozet')">📊 Sorumlu Özeti</button>
  </nav>

  <section id="ana" class="active">
    <h3>🔍 Kayıtlar</h3>
    <label>İş Başlığı:</label><input type="text" id="titleFilter">
    <label>Sorumlu:</label><input type="text" id="responsibleFilter">
    <label>Durum:</label>
    <select id="statusFilter">
      <option value="">Tümü</option>
      <option value="Devam Ediyor">Devam Ediyor</option>
      <option value="Tamamlandı">Tamamlandı</option>
    </select>
    <div id="cardContainer"></div>
  </section>

  <section id="formekrani">
    <h3>📝 Yeni Kayıt Ekle</h3>
    <p><a href="https://forms.gle/euosi3bVqsMn5zBp9" target="_blank" style="color:#2980b9; font-weight:bold;">➡ Google Formu Buradan Aç</a></p>
    <p>Form yeni sekmede açılacaktır. Veriler tabloya otomatik yansıyacaktır.</p>
  </section>

  <section id="ozet">
    <h3>📊 Sorumlu Özeti</h3>
    <div id="summaryContainer"></div>
  </section>

  <script>
    const SHEET_ID = "1Ppo2L8kO8fgOmFrY956MdGOVjyfOBDnbcvOx2KmR0fY";
    const SHEET_GID = "0";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;

    function switchTab(tabId) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tablink').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
      if (tabId === 'ana') refreshData();
      if (tabId === 'ozet') renderSummary();
    }

    function formatDate(input) {
      if (typeof input === 'string') {
        if (input.startsWith("Date(")) {
          try {
            const match = input.match(/Date\((\d+),(\d+),(\d+)\)/);
            if (match) {
              const year = parseInt(match[1]);
              const month = parseInt(match[2]);
              const day = parseInt(match[3]);
              return `${String(day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`;
            }
          } catch (e) { return input; }
        }
        return input;
      }
      if (typeof input === 'object' && input && 'v' in input) {
        const d = new Date(input.v);
        return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
      }
      const d = new Date(input);
      if (isNaN(d)) return input;
      return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
    }

    async function fetchData() {
      const res = await fetch(SHEET_URL);
      const text = await res.text();
      const json = JSON.parse(text.substring(47).slice(0, -2));
      return json.table.rows.map(row => row.c.map(cell => cell ? cell.v : ""));
    }

    function renderTable(data) {
      const container = document.getElementById("cardContainer");
      container.innerHTML = "";
      const titleFilter = document.getElementById("titleFilter").value.toLowerCase();
      const responsibleFilter = document.getElementById("responsibleFilter").value.toLowerCase();
      const statusFilter = document.getElementById("statusFilter").value;

      let table = `<table><tr>
        <th>İş Başlığı</th><th>İş Tanımı</th><th>Sorumlu</th>
        <th>Başlangıç</th><th>Bitiş</th><th>Durum</th>
        <th>Öncelik</th><th>Not</th>
      </tr>`;

      data.forEach(row => {
        const [ , title, desc, responsible, start, end, status, priority, note] = row;
        if (!title) return;
        if (
          (!titleFilter || title.toLowerCase().includes(titleFilter)) &&
          (!responsibleFilter || responsible.toLowerCase().includes(responsibleFilter)) &&
          (!statusFilter || status === statusFilter)
        ) {
          table += `<tr>
            <td>${title}</td>
            <td>${desc}</td>
            <td>${responsible}</td>
            <td>${formatDate(start)}</td>
            <td>${formatDate(end)}</td>
            <td>${status}</td>
            <td>${priority}</td>
            <td>${note}</td>
          </tr>`;
        }
      });

      table += `</table>`;
      container.innerHTML = table;
    }

    async function refreshData() {
      const data = await fetchData();
      renderTable(data);
    }

    async function renderSummary() {
      const data = await fetchData();
      const summary = {};
      data.forEach(row => {
        const responsible = row[3] || "Bilinmeyen";
        const status = row[6] || "Bilinmiyor";
        if (!summary[responsible]) summary[responsible] = { total: 0, Tamamlandı: 0, Bekliyor: 0 };
        summary[responsible].total++;
        if (status === "Tamamlandı") summary[responsible].Tamamlandı++;
        else summary[responsible].Bekliyor++;
      });

      let html = "<table><tr><th>Sorumlu</th><th>Toplam</th><th>Tamamlandı</th><th>Bekliyor</th></tr>";
      for (let key in summary) {
        html += `<tr><td>${key}</td><td>${summary[key].total}</td><td>${summary[key].Tamamlandı}</td><td>${summary[key].Bekliyor}</td></tr>`;
      }
      html += "</table>";
      document.getElementById("summaryContainer").innerHTML = html;
    }

    refreshData();
  </script>
</body>
</html>
