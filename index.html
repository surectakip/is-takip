<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>İş - Süreç Takip</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    html, body { height:100%; font-family:sans-serif; }
    nav { display:flex; flex-wrap:wrap; background:#007acc; }
    nav button {
      flex:1 1 100px; padding:.75rem; border:none;
      background:#005fa3; color:#fff; font-weight:bold; cursor:pointer;
    }
    nav button.active { background:#003f7f; }
    .tab {
      display:none;
      height:calc(100% - 3.5rem);
      overflow:hidden;
      position:relative;
    }
    .tab.active { display:block; }
    iframe { border:none; width:100%; }
    h1 { padding:1rem; }
    .link-bottom, .chart-header {
      position:absolute; bottom:0; width:100%;
      background:rgba(255,255,255,0.85); padding:.5rem 1rem;
      text-align:right;
    }
    .link-bottom a, .chart-header a {
      color:#007acc; text-decoration:none; font-weight:bold;
    }
    .charts-grid {
      display:flex; flex-direction:column; height:100%;
    }
    .chart-container {
      position:relative; flex:1; margin:1rem;
    }
    .chart-container iframe {
      position:absolute; top:0; left:0; width:100%; height:100%;
    }
    @media(max-width:600px) {
      nav button { flex:1 1 100%; }
    }
  </style>
</head>
<body>
  <nav>
    <button id="btn-entry" class="active">Giriş</button>
    <button id="btn-results">Sonuçlar</button>
    <button id="btn-data">Takip</button>
    <button id="btn-query">Sorgu</button>
    <button id="btn-edit">Düzenle</button>
    <button id="btn-charts">Grafikler</button>
  </nav>

  <!-- 1. İş-Görev Giriş -->
  <div id="tab-entry" class="tab active" style="display:flex; flex-direction:column;">
    <iframe
      src="https://docs.google.com/forms/d/e/1FAIpQLSeWCzjSbJvwt-aK2r76ksmUjZNKzfmmeMeJKX_gC97V-7-iNw/viewform?embedded=true"
      allowfullscreen
      style="flex:1;">
    </iframe>
    <p class="link-bottom">
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSeWCzjSbJvwt-aK2r76ksmUjZNKzfmmeMeJKX_gC97V-7-iNw/viewform"
         target="_blank" rel="noopener">
        ➤ Yeni Pencerede Aç
      </a>
    </p>
  </div>

  <!-- 2. Form Sonuçları -->
  <div id="tab-results" class="tab">
    <p style="padding:1rem;">
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSeWCzjSbJvwt-aK2r76ksmUjZNKzfmmeMeJKX_gC97V-7-iNw/viewanalytics"
         target="_blank" rel="noopener">
        ➤ Analizleri Yeni Pencerede Aç
      </a>
    </p>
  </div>

  <!-- 3. İş-Süreç Takip -->
  <div id="tab-data" class="tab">
    <h1>İş-Süreç Takip</h1>
    <div style="padding:1rem;">
      <button onclick="loadData()" style="padding:.5rem 1rem;background:#007acc;color:#fff;border:none;">
        Yenile
      </button>
      <span id="loading" style="margin-left:1rem;display:none;">Yükleniyor…</span>
    </div>
    <div style="overflow-x:auto; padding:1rem; height:calc(100% - 4.5rem);">
      <table id="responses-table" style="width:100%; border-collapse:collapse;">
        <thead id="table-head"></thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>

  <!-- 4. Sorgu -->
  <div id="tab-query" class="tab">
    <h1>Ana Tablo Sorgu</h1>
    <div style="display:flex; flex-wrap:wrap; gap:.5rem; padding:1rem;">
      <select id="f-resp"><option value="">Tümü (Sorumlu)</option></select>
      <select id="f-stat"><option value="">Tümü (Durum)</option></select>
      <select id="f-prio"><option value="">Tümü (Öncelik)</option></select>
      <input type="date" id="f-from">
      <input type="date" id="f-to">
      <input type="text" id="f-text" placeholder="Anahtar kelime">
      <button onclick="applyFilter()" style="background:#28a745;color:#fff;">Uygula</button>
      <button onclick="resetFilter()" style="background:#dc3545;color:#fff;">Temizle</button>
    </div>
    <div style="overflow-x:auto; padding:1rem; height:calc(100% - 6.5rem);">
      <table id="query-table" style="width:100%; border-collapse:collapse;">
        <thead id="query-head"></thead>
        <tbody id="query-body"></tbody>
      </table>
    </div>
  </div>

  <!-- 5. Düzenle -->
  <div id="tab-edit" class="tab" style="padding:1rem;">
    <h1>Google Sheets’te Düzenle</h1>
    <button onclick="window.open(
      'https://docs.google.com/spreadsheets/d/1MRE6qxE6jj9CXm2J6AP6glijTMR-Bn9imPLHRvAErfU/edit', '_blank')"
      style="padding:.5rem 1rem;background:#17a2b8;color:#fff;border:none;">
      Aç ve Düzenle
    </button>
  </div>

  <!-- 6. Grafikler -->
  <div id="tab-charts" class="tab" style="display:flex; flex-direction:column;">
    <h1 style="padding:1rem;">Canlı Grafikler</h1>
    <div class="charts-grid" style="flex:1; display:flex; gap:1rem; padding:1rem;">
      <div class="chart-container">
        <iframe
          src="https://docs.google.com/spreadsheets/d/e/2PACX-1vR3FYXQ_1zylldMKZ73oBRLvbE0QgfOfdZoR6ZP6Pay-D_YH2uuiptRt5XsJIQekxOkbwRplBBGNT4u/pubchart?oid=1960847737&format=interactive">
        </iframe>
        <div class="chart-header">Sorumlulara Göre Dağılım</div>
      </div>
      <div class="chart-container">
        <iframe
          src="https://docs.google.com/spreadsheets/d/e/2PACX-1vR3FYXQ_1zylldMKZ73oBRLvbE0QgfOfdZoR6ZP6Pay-D_YH2uuiptRt5XsJIQekxOkbwRplBBGNT4u/pubchart?oid=1533843598&format=interactive">
        </iframe>
        <div class="chart-header">Durum Dağılımı</div>
      </div>
      <div class="chart-container">
        <iframe
          src="https://docs.google.com/spreadsheets/d/e/2PACX-1vR3FYXQ_1zylldMKZ73oBRLvbE0QgfOfdZoR6ZP6Pay-D_YH2uuiptRt5XsJIQekxOkbwRplBBGNT4u/pubchart?oid=1650909334&format=interactive">
        </iframe>
        <div class="chart-header">Öncelik Dağılımı</div>
      </div>
    </div>
  </div>

  <script>
    const tabs=['entry','results','data','query','edit','charts'];
    tabs.forEach(t=> {
      document.getElementById('btn-'+t).onclick = () => {
        tabs.forEach(x=> {
          document.getElementById('btn-'+x)
            .classList.toggle('active', x===t);
          document.getElementById('tab-'+x)
            .classList.toggle('active', x===t);
        });
        if(t==='data') loadData();
      };
    });

    const sheetUrl =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3FYXQ_1zylldMKZ73oBRLvbE0QgfOfdZoR6ZP6Pay-D_YH2uuiptRt5XsJIQekxOkbwRplBBGNT4u/pub?output=csv';
    let allRows=[], headers=[];

    async function loadData(){
      document.getElementById('loading').style.display='inline';
      const res = await fetch(sheetUrl);
      if(!res.ok){ alert('CSV okunamadı: '+res.status); return; }
      const txt = await res.text();
      const rows = txt.trim().split('\n').map(r=>r.split(','));
      headers = rows.shift(); allRows = rows;
      const thead = '<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>';
      const tbody = allRows.map(r=>
        '<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>'
      ).join('');
      document.getElementById('table-head').innerHTML=thead;
      document.getElementById('table-body').innerHTML=tbody;
      document.getElementById('loading').style.display='none';
      ['f-resp','f-stat','f-prio'].forEach((id,i)=>populate(id,[3,6,7][i]));
      document.getElementById('query-head').innerHTML=thead;
    }

    function populate(selId, col){
      const sel=document.getElementById(selId);
      const vals=Array.from(new Set(allRows.map(r=>r[col]))).sort();
      sel.innerHTML='<option value="">Tümü</option>'+
        vals.map(v=>`<option>${v}</option>`).join('');
    }

    function applyFilter(){
      let f=allRows.slice();
      const v1=document.getElementById('f-resp').value;
      const v2=document.getElementById('f-stat').value;
      const v3=document.getElementById('f-prio').value;
      const from=document.getElementById('f-from').value;
      const to=document.getElementById('f-to').value;
      const txt=document.getElementById('f-text').value.toLowerCase();
      if(v1) f=f.filter(r=>r[3]===v1);
      if(v2) f=f.filter(r=>r[6]===v2);
      if(v3) f=f.filter(r=>r[7]===v3);
      if(from) f=f.filter(r=>new Date(r[4])>=new Date(from));
      if(to)   f=f.filter(r=>new Date(r[4])<=new Date(to));
      if(txt)  f=f.filter(r=>r.join(' ').toLowerCase().includes(txt));
      document.getElementById('query-body').innerHTML =
        f.map(r=>'<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>').join('');
    }

    function resetFilter(){
      ['f-resp','f-stat','f-prio','f-from','f-to','f-text']
        .forEach(id=>document.getElementById(id).value='');
      document.getElementById('query-body').innerHTML='';
    }
  </script>
</body>
</html>
