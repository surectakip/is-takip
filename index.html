<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Ä°ÅŸ Takip Sistemi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    nav button { margin: 8px; padding: 10px; font-size: 15px; cursor: pointer; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #eee; }
    canvas { margin-top: 20px; background: white; padding: 10px; border-radius: 8px; }
    .danger { background-color: #ffe5e5 !important; }
    .filters { margin-top: 10px; }
    .filters select, .filters button { margin-right: 10px; padding: 5px; }
  </style>
</head>
<body>
  <h1>ðŸ“‹ Ä°ÅŸ Takip Sistemi</h1>
  <nav>
    <button onclick="showTab('panel')">Ana Tablo</button>
    <button onclick="showTab('analiz')">Analiz</button>
    <button onclick="showTab('form')">Veri GiriÅŸi</button>
    <button onclick="fetchData()">ðŸ”„ Yenile</button>
  </nav>

  <section id="panel">
    <div class="filters">
      <label>Sorumlu:</label>
      <select id="filterSorumlu"><option value="">TÃ¼mÃ¼</option></select>

      <label>Durum:</label>
      <select id="filterDurum"><option value="">TÃ¼mÃ¼</option></select>

      <label>Ã–ncelik:</label>
      <select id="filterOncelik"><option value="">TÃ¼mÃ¼</option></select>

      <button onclick="applyFilters()">Filtrele</button>
      <button onclick="clearFilters()">Temizle</button>
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th>Zaman</th><th>Ä°ÅŸ BaÅŸlÄ±ÄŸÄ±</th><th>Ä°ÅŸ TanÄ±mÄ±</th><th>Sorumlu</th>
          <th>BaÅŸlangÄ±Ã§</th><th>BitiÅŸ</th><th>Durum</th><th>Ã–ncelik</th><th>Not</th><th>HatÄ±rlatma</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="analiz" class="hidden">
    <canvas id="chart1"></canvas>
    <canvas id="chart2"></canvas>
  </section>

  <section id="form" class="hidden">
    <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSeO5gyy2PE4zRvj_OUhTE00M63M_xezHDMtjsdU4FcOWqc9lw/viewform?embedded=true" width="100%" height="1800" frameborder="0" marginheight="0" marginwidth="0">YÃ¼kleniyorâ€¦</iframe>
  </section>

  <script>
    const sheetID = '1lhW-0Gn38DH-GYPOHZkvZvfL8hsaNYj6vyA_Rnli7EU';
    const sheetName = 'Form YanÄ±tlarÄ± 1';
    const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=SELECT *`;

    let fullData = [];

    function showTab(id) {
      ['panel','analiz','form'].forEach(sec => {
        document.getElementById(sec).classList.add('hidden');
      });
      document.getElementById(id).classList.remove('hidden');
    }

    function fetchData() {
      fetch(url)
        .then(res => res.text())
        .then(rep => {
          const json = JSON.parse(rep.substr(47).slice(0, -2));
          const rows = json.table.rows;
          fullData = rows.map(row => row.c.map(cell => cell?.v || ''));

          renderTable(fullData);
          renderFilters(fullData);
          renderCharts(fullData);
        });
    }

    function renderTable(data) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      const now = new Date();

      data.forEach(row => {
        const [zaman, baslik, tanim, sorumlu, baslangic, bitis, durum, oncelik, not, hatirlatma] = row;
        const tr = document.createElement("tr");

        // GecikmiÅŸ renk kontrolÃ¼
        const bitisDate = parseDate(bitis);
        const hatirlatmaDate = parseDate(hatirlatma);
        const gecikmis = (bitisDate && bitisDate < now) || (hatirlatmaDate && hatirlatmaDate < now);

        if (gecikmis && durum !== "TamamlandÄ±") tr.classList.add("danger");

        [zaman, baslik, tanim, sorumlu, baslangic, bitis, durum, oncelik, not, hatirlatma].forEach(text => {
          const td = document.createElement("td");
          td.textContent = text;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    function parseDate(input) {
      if (typeof input === 'string' && input.includes('.')) {
        const [d, m, y] = input.split('.');
        return new Date(`${y}-${m}-${d}`);
      }
      const dt = new Date(input);
      return isNaN(dt) ? null : dt;
    }

    function renderFilters(data) {
      const sorumluSet = new Set(), durumSet = new Set(), oncelikSet = new Set();
      data.forEach(([,, , sorumlu,, , durum, oncelik]) => {
        sorumlu && sorumluSet.add(sorumlu);
        durum && durumSet.add(durum);
        oncelik && oncelikSet.add(oncelik);
      });

      populateSelect('filterSorumlu', sorumluSet);
      populateSelect('filterDurum', durumSet);
      populateSelect('filterOncelik', oncelikSet);
    }

    function populateSelect(id, set) {
      const select = document.getElementById(id);
      select.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
      [...set].sort().forEach(val => {
        const opt = document.createElement("option");
        opt.value = opt.textContent = val;
        select.appendChild(opt);
      });
    }

    function applyFilters() {
      const fs = document.getElementById('filterSorumlu').value;
      const fd = document.getElementById('filterDurum').value;
      const fo = document.getElementById('filterOncelik').value;

      const filtered = fullData.filter(([,, , sorumlu,, , durum, oncelik]) => {
        return (!fs || fs === sorumlu) &&
               (!fd || fd === durum) &&
               (!fo || fo === oncelik);
      });

      renderTable(filtered);
    }

    function clearFilters() {
      document.getElementById('filterSorumlu').value = '';
      document.getElementById('filterDurum').value = '';
      document.getElementById('filterOncelik').value = '';
      renderTable(fullData);
    }

    function renderCharts(data) {
      const sorumluMap = {}, durumMap = {};
      data.forEach(([, , , sorumlu, , , durum]) => {
        if (!sorumluMap[sorumlu]) sorumluMap[sorumlu] = 0;
        sorumluMap[sorumlu]++;
        if (!durumMap[durum]) durumMap[durum] = 0;
        durumMap[durum]++;
      });

      new Chart(document.getElementById("chart1"), {
        type: 'bar',
        data: {
          labels: Object.keys(sorumluMap),
          datasets: [{
            label: 'Sorumluya GÃ¶re Ä°ÅŸ SayÄ±sÄ±',
            data: Object.values(sorumluMap),
            backgroundColor: 'steelblue'
          }]
        }
      });

      new Chart(document.getElementById("chart2"), {
        type: 'pie',
        data: {
          labels: Object.keys(durumMap),
          datasets: [{
            label: 'Durum DaÄŸÄ±lÄ±mÄ±',
            data: Object.values(durumMap),
            backgroundColor: ['#ff9999','#66b3ff','#99ff99','#ffcc99']
          }]
        }
      });
    }

    fetchData();
  </script>
</body>
</html>
