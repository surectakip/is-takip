<script>
const SHEET_ID = "1Ppo2L8kO8fgOmFrY956MdGOVjyfOBDnbcvOx2KmR0fY";
const SHEET_GID = "0";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;

function switchTab(tabId) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tablink').forEach(b => b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  event.target.classList.add('active');
  if (tabId === 'grafikler') loadAndRender();
  if (tabId === 'ana') refreshData();
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return `${d.getDate().toString().padStart(2, '0')}.${(d.getMonth()+1).toString().padStart(2, '0')}.${d.getFullYear()}`;
}

async function fetchData() {
  const res = await fetch(SHEET_URL);
  const text = await res.text();
  const json = JSON.parse(text.substring(47).slice(0, -2));
  return json.table.rows.map(row => row.c.map(cell => cell ? cell.v : ""));
}

function renderTable(data) {
  const container = document.getElementById("cardContainer");
  container.innerHTML = "";
  const titleFilter = document.getElementById("titleFilter").value.toLowerCase();
  const responsibleFilter = document.getElementById("responsibleFilter").value.toLowerCase();
  const statusFilter = document.getElementById("statusFilter").value;
  const today = new Date();
  let reminderFlag = false;
  let reminderText = "";

  data.forEach(row => {
    const [timestamp, title, desc, responsible, start, end, status, priority, note, reminderDays] = row;
    if (!title) return; // boÅŸ satÄ±rÄ± atla
    if (
      (!titleFilter || title.toLowerCase().includes(titleFilter)) &&
      (!responsibleFilter || responsible.toLowerCase().includes(responsibleFilter)) &&
      (!statusFilter || status === statusFilter)
    ) {
      const div = document.createElement("div");
      div.className = "card";

      const startDate = new Date(start);
      const endDate = new Date(end);
      const reminder = parseInt(reminderDays);
      let isReminder = false;
      if (!isNaN(reminder)) {
        const remindDate = new Date(startDate);
        remindDate.setDate(remindDate.getDate() + reminder);
        isReminder = remindDate.toDateString() === today.toDateString();
        if (isReminder) {
          reminderFlag = true;
          reminderText += `\nğŸ”” ${title} - ${responsible} (${formatDate(start)} â†’ ${formatDate(end)})`;
        }
      }

      if (status === "TamamlandÄ±") div.classList.add("green");
      else if (endDate < today) div.classList.add("red");

      div.innerHTML = `
        <p><strong>Ä°ÅŸ BaÅŸlÄ±ÄŸÄ±:</strong> ${title}</p>
        <p><strong>Ä°ÅŸ TanÄ±mÄ±:</strong> ${desc}</p>
        <p><strong>Sorumlu:</strong> ${responsible}</p>
        <p><strong>BaÅŸlangÄ±Ã§:</strong> ${formatDate(start)}</p>
        <p><strong>BitiÅŸ:</strong> ${formatDate(end)}</p>
        <p><strong>Durum:</strong> ${status}</p>
        <p><strong>Ã–ncelik:</strong> ${priority}</p>
        <p><strong>Not:</strong> ${note}</p>
      `;
      container.appendChild(div);
    }
  });

  if (reminderFlag) {
    alert("BUGÃœN HATIRLATILACAK Ä°ÅLER:" + reminderText);
  }
}

async function refreshData() {
  const data = await fetchData();
  renderTable(data);
}

async function loadAndRender() {
  const data = await fetchData();
  renderTable(data);
  // grafik iÅŸlemleri buraya eklenecek
}

refreshData();
</script>
