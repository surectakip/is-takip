<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>İş ve Süreç Takip Sistemi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; }
    header { background-color: #0d6efd; color: white; padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; }
    nav { margin-top: 1rem; }
    .tab-content { margin-top: 1rem; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    .reminder-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: flex; align-items: center;
      justify-content: center; z-index: 9999;
    }
    .reminder-box {
      background: white; padding: 2rem; border-radius: 10px;
      max-width: 400px; box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <header>İş ve Süreç Takip Sistemi</header>
  <nav class="nav nav-tabs justify-content-center">
    <a class="nav-link active" href="#tablo" onclick="showTab('tablo')">Ana Sayfa</a>
    <a class="nav-link" href="#form" onclick="showTab('form')">Veri Girişi</a>
    <a class="nav-link" href="#grafik" onclick="showTab('grafik')">Sorumlu Özeti</a>
  </nav>

  <main class="container">
    <div class="tab-content">
      <section id="tablo" class="tab-pane active">
        <input type="text" class="form-control my-3" id="searchInput" placeholder="İş başlığına göre ara" oninput="filterTable()">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th>İş Başlığı</th>
                <th>İş Tanımı</th>
                <th>Sorumlu</th>
                <th>Başlangıç</th>
                <th>Bitiş</th>
                <th>Durum</th>
                <th>Öncelik</th>
                <th>Not</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </section>

      <section id="form" class="tab-pane">
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScJcS29cdGxv4yYkGUFfDZ9prp6A7TUtlHQO9PZmlfGyaL_cw/viewform?embedded=true" width="100%" height="900" frameborder="0" marginheight="0" marginwidth="0">Yükleniyor…</iframe>
      </section>

      <section id="grafik" class="tab-pane">
        <canvas id="durumChart"></canvas>
        <canvas id="oncelikChart"></canvas>
        <canvas id="ayChart"></canvas>
        <div id="summaryList" class="mt-3"></div>
      </section>
    </div>
  </main>

  <div id="reminderModal" class="reminder-modal" style="display:none">
    <div class="reminder-box">
      <h5>Hatırlatmalar</h5>
      <ul id="reminderList"></ul>
      <button class="btn btn-sm btn-danger mt-3" onclick="document.getElementById('reminderModal').style.display='none'">Kapat</button>
    </div>
  </div>

  <script>
    function showTab(tabId) {
      document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
      document.querySelector(`[href='#${tabId}']`).classList.add('active');
    }

    function formatDate(input) {
      if (!input) return "";
      if (typeof input === "string" && input.includes("/")) {
        const [m, d, y] = input.split("/");
        return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
      }
      const date = new Date(input);
      if (isNaN(date)) return input;
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function fetchData() {
      fetch('https://docs.google.com/spreadsheets/d/1Ppo2L8kO8fgOmFrY956MdGOVjyfOBDnbcvOx2KmR0fY/gviz/tq?tqx=out:json')
        .then(res => res.text())
        .then(text => JSON.parse(text.substr(47).slice(0, -2)))
        .then(json => {
          const data = json.table.rows.map(row => row.c.map(cell => (cell && cell.v) ? cell.v : ""));
          renderTable(data);
          renderCharts(data);
          renderSummary(data);
          checkReminders(data);
        });
    }

    function renderTable(data) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const [ , title, desc, responsible, start, end, status, priority, note ] = row;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${title}</td>
          <td>${desc}</td>
          <td>${responsible}</td>
          <td>${formatDate(start)}</td>
          <td>${formatDate(end)}</td>
          <td>${status}</td>
          <td>${priority}</td>
          <td>${note}</td>
        `;
        if (status.toLowerCase() === 'tamamlandı') tr.classList.add("table-success");
        else if (new Date(end) < new Date()) tr.classList.add("table-danger");
        tbody.appendChild(tr);
      });
    }

    function filterTable() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#tableBody tr");
      rows.forEach(row => {
        const text = row.cells[0].textContent.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
      });
    }

    function checkReminders(data) {
      const today = new Date(); today.setHours(0,0,0,0);
      const reminders = [];
      data.forEach(row => {
        const [ , title, , , startRaw, endRaw, , , , reminderDays] = row;
        const start = new Date(Date.parse(startRaw));
        const end = new Date(Date.parse(endRaw));
        if (!isNaN(start) && reminderDays) {
          const reminderDate = new Date(start);
          reminderDate.setDate(reminderDate.getDate() + parseInt(reminderDays));
          reminderDate.setHours(0,0,0,0);
          if (reminderDate.getTime() === today.getTime()) {
            reminders.push(`🔔 ${title} - Hatırlatma günü geldi.`);
          }
        }
        if (!isNaN(end)) {
          end.setHours(0,0,0,0);
          if (end.getTime() === today.getTime()) {
            reminders.push(`⏰ ${title} - Bitiş süresi bugün doluyor.`);
          }
        }
      });
      if (reminders.length > 0) {
        const list = document.getElementById("reminderList");
        list.innerHTML = reminders.map(item => `<li>${item}</li>`).join("");
        document.getElementById("reminderModal").style.display = "flex";
      }
    }

    function renderSummary(data) {
      const summary = {};
      data.forEach(row => {
        const responsible = row[3];
        const status = row[6].toLowerCase();
        if (!summary[responsible]) summary[responsible] = { tamamlandı: 0, bekliyor: 0 };
        if (status === 'tamamlandı') summary[responsible].tamamlandı++;
        else summary[responsible].bekliyor++;
      });
      let html = '<h5 class="mt-3">Sorumluya Göre Özet</h5><ul class="list-group">';
      for (const [name, val] of Object.entries(summary)) {
        html += `<li class="list-group-item">👤 <strong>${name}</strong> → ✅ ${val.tamamlandı} | ⏳ ${val.bekliyor}</li>`;
      }
      html += '</ul>';
      document.getElementById("summaryList").innerHTML = html;
    }

    function renderCharts(data) {
      const statusCounts = {}, priorityCounts = {}, monthCounts = {};
      data.forEach(row => {
        const status = row[6];
        const priority = row[7];
        const date = new Date(row[4]);
        const month = isNaN(date) ? "Bilinmeyen" : date.toLocaleString('tr-TR', { month: 'long' });
        statusCounts[status] = (statusCounts[status] || 0) + 1;
        priorityCounts[priority] = (priorityCounts[priority] || 0) + 1;
        monthCounts[month] = (monthCounts[month] || 0) + 1;
      });

      new Chart(document.getElementById("durumChart"), {
        type: 'pie',
        data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts) }] }
      });
      new Chart(document.getElementById("oncelikChart"), {
        type: 'bar',
        data: { labels: Object.keys(priorityCounts), datasets: [{ data: Object.values(priorityCounts) }] }
      });
      new Chart(document.getElementById("ayChart"), {
        type: 'line',
        data: { labels: Object.keys(monthCounts), datasets: [{ data: Object.values(monthCounts) }] }
      });
    }

    fetchData();
  </script>
</body>
</html>
